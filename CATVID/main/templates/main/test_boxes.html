<!DOCTYPE html>
<html>
<head>
    <title>Тест ящиков</title>
    <meta charset="utf-8">
</head>
<body>
    <h1>Тест системы ящиков</h1>
    
    <div id="info">
        <p>Загрузка...</p>
    </div>
    
    <div id="boxes">
        <!-- Ящики будут загружены через JavaScript -->
    </div>
    
    <script>
        // Получаем CSRF токен
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Загружаем информацию о ящиках
        fetch('/')
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Ищем информацию об игроке
            const playerIdElement = doc.getElementById('player-id');
            const coinsElement = doc.getElementById('coins');
            
            if (playerIdElement && coinsElement) {
                const playerId = playerIdElement.value;
                const coins = coinsElement.textContent;
                
                document.getElementById('info').innerHTML = `
                    <p>ID игрока: ${playerId}</p>
                    <p>Монеты: ${coins}</p>
                `;
                
                // Ищем ящики
                const boxCards = doc.querySelectorAll('.box-card');
                let boxesHtml = '<h2>Доступные ящики:</h2>';
                
                if (boxCards.length > 0) {
                    boxCards.forEach(card => {
                        const boxId = card.dataset.boxId;
                        const boxName = card.querySelector('h3').textContent;
                        const boxPrice = card.querySelector('.box-price').textContent;
                        
                        boxesHtml += `
                            <div style="border: 1px solid #ccc; padding: 10px; margin: 10px;">
                                <h3>${boxName}</h3>
                                <p>Цена: ${boxPrice} монет</p>
                                <button onclick="testBuyBox(${boxId}, ${boxPrice})">Купить ящик</button>
                            </div>
                        `;
                    });
                } else {
                    boxesHtml += '<p>Ящики не найдены!</p>';
                }
                
                document.getElementById('boxes').innerHTML = boxesHtml;
            } else {
                document.getElementById('info').innerHTML = '<p>Ошибка: не удалось получить информацию об игроке</p>';
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            document.getElementById('info').innerHTML = '<p>Ошибка загрузки</p>';
        });
        
        // Функция для тестирования покупки ящика
        function testBuyBox(boxId, price) {
            console.log(`Тестируем покупку ящика ${boxId} за ${price} монет`);
            
            fetch('/buy_box/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    box_id: boxId
                })
            })
            .then(response => {
                console.log('Статус ответа:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Ответ сервера:', data);
                
                if (data.success) {
                    alert(`Успех! Получено: ${data.result.message}`);
                } else {
                    alert(`Ошибка: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Ошибка сети:', error);
                alert('Ошибка сети');
            });
        }
    </script>
</body>
</html>